name: Sanitize v2ray subscription

on:
  schedule:
    - cron: "*/30 * * * *"
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: pip install requests

      - name: Run sanitizer
        run: |
          python <<EOF
          import re, requests

          SRC_URL = open("source.txt").read().strip()
          ALLOWED_PORTS = {"443", "2096"}
          SAFE_SNI = {"microsoft.com","www.microsoft.com","aws.amazon.com","www.paypal.com","dropbox.com"}
          SAFE_SUFFIX = [".cloudflare.com",".microsoft.com",".amazon.com",".paypal.com","dropbox.com"]

          def is_safe(url):
              if "security=none" in url or "encryption=none" in url: return False
              if url.startswith(("vmess://","ss://")): return False
              port = re.search(r":(\d+)/\?", url)
              if not port or port.group(1) not in ALLOWED_PORTS: return False
              if url.startswith("vless://"):
                  if "security=reality" in url and "pbk=" in url and "sni=" in url:
                      sni = re.search(r"sni=([^&]+)", url)
                      s = sni.group(1) if sni else ""
                      return s in SAFE_SNI or any(s.endswith(x) for x in SAFE_SUFFIX)
                  elif "security=tls" in url and ("type=ws" in url or "type=grpc" in url):
                      host = re.search(r"host=([^&]+)", url)
                      h = host.group(1) if host else ""
                      return h in SAFE_SNI or any(h.endswith(x) for x in SAFE_SUFFIX)
              elif url.startswith("trojan://") and "security=tls" in url:
                  sni = re.search(r"sni=([^&]+)", url)
                  s = sni.group(1) if sni else ""
                  return s in SAFE_SNI or any(s.endswith(x) for x in SAFE_SUFFIX)
              return False

          raw = requests.get(SRC_URL).text.splitlines()
          safe = [u for u in raw if is_safe(u.strip())]
          with open("sanitized_sub.txt","w",encoding="utf-8") as f: f.write("\n".join(safe))
          EOF

      - name: Upload to GitHub Pages
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_branch: gh-pages
          publish_dir: .
